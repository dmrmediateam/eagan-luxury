// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// MLS registry
model Mls {
  id       Int     @id @default(autoincrement())
  name     String
  vendor   String?
  timezone String  @default("UTC")

  // Relations
  listings        Listing[]
  media           Media[]
  openHouses      OpenHouse[]
  rooms           Room[]
  units           Unit[]
  members         Member[]
  offices         Office[]
  lookupValues    LookupValue[]
  priceHistories  PriceHistory[]
  statusHistories StatusHistory[]

  @@map("mls")
}

// Core listing (RESO Property)
model Listing {
  id                    BigInt    @id @default(autoincrement())
  mlsId                 Int
  listingKey            String // RESO ListingKey (unique per MLS)
  listingId             String? // public-facing ID
  standardStatus        String? // RESO StandardStatus
  propertyType          String?
  propertySubType       String?
  listPrice             Decimal?  @db.Decimal(14, 2)
  closePrice            Decimal?  @db.Decimal(14, 2)
  originalListPrice     Decimal?  @db.Decimal(14, 2)
  listDate              DateTime? @db.Timestamptz(6)
  onMarketDate          DateTime? @db.Timestamptz(6)
  offMarketDate         DateTime? @db.Timestamptz(6)
  closeDate             DateTime? @db.Timestamptz(6)
  bedsTotal             Int?
  bathsFull             Int?
  bathsHalf             Int?
  livingArea            Int?
  lotSizeAcres          Decimal?  @db.Decimal(10, 4)
  yearBuilt             Int?
  latitude              Decimal?  @db.Decimal(9, 6)
  longitude             Decimal?  @db.Decimal(9, 6)
  addressFull           String?
  city                  String?
  state                 String?
  postalCode            String?
  county                String?
  subdivision           String?
  remarksPublic         String?
  listingAgentKey       String?
  listingOfficeKey      String?
  deletedYn             Boolean   @default(false)
  modificationTimestamp DateTime? @db.Timestamptz(6)
  extrasJson            Json      @default("{}")

  // Relations
  mls             Mls             @relation(fields: [mlsId], references: [id], onDelete: Restrict)
  media           Media[]
  openHouses      OpenHouse[]
  rooms           Room[]
  units           Unit[]
  priceHistories  PriceHistory[]
  statusHistories StatusHistory[]

  @@unique([mlsId, listingKey])
  @@index([standardStatus, listPrice])
  @@index([city])
  @@index([postalCode])
  @@index([modificationTimestamp])
  @@map("listing")
}

// Media (photos, videos, 3D)
model Media {
  id                         BigInt    @id @default(autoincrement())
  listingKey                 String
  mlsId                      Int
  mediaKey                   String?
  url                        String
  order                      Int?
  category                   String?
  caption                    String?
  mediaModificationTimestamp DateTime? @db.Timestamptz(6)
  extrasJson                 Json      @default("{}")

  // Relations
  mls     Mls     @relation(fields: [mlsId], references: [id], onDelete: Restrict)
  listing Listing @relation(fields: [mlsId, listingKey], references: [mlsId, listingKey], onDelete: Restrict)

  @@index([mlsId, listingKey])
  @@map("media")
}

// Open houses
model OpenHouse {
  id         BigInt    @id @default(autoincrement())
  listingKey String
  mlsId      Int
  startTime  DateTime  @db.Timestamptz(6)
  endTime    DateTime? @db.Timestamptz(6)
  remarks    String?
  extrasJson Json      @default("{}")

  // Relations
  mls     Mls     @relation(fields: [mlsId], references: [id], onDelete: Restrict)
  listing Listing @relation(fields: [mlsId, listingKey], references: [mlsId, listingKey], onDelete: Restrict)

  @@index([mlsId, listingKey])
  @@map("open_house")
}

// Rooms
model Room {
  id           BigInt   @id @default(autoincrement())
  listingKey   String
  mlsId        Int
  roomType     String?
  level        String?
  length       Decimal? @db.Decimal(6, 2)
  width        Decimal? @db.Decimal(6, 2)
  featuresJson Json     @default("{}")

  // Relations
  mls     Mls     @relation(fields: [mlsId], references: [id], onDelete: Restrict)
  listing Listing @relation(fields: [mlsId, listingKey], references: [mlsId, listingKey], onDelete: Restrict)

  @@index([mlsId, listingKey])
  @@map("room")
}

// Units (for multi-family)
model Unit {
  id         BigInt   @id @default(autoincrement())
  listingKey String
  mlsId      Int
  beds       Int?
  bathsFull  Int?
  sqft       Int?
  rent       Decimal? @db.Decimal(12, 2)
  extrasJson Json     @default("{}")

  // Relations
  mls     Mls     @relation(fields: [mlsId], references: [id], onDelete: Restrict)
  listing Listing @relation(fields: [mlsId, listingKey], references: [mlsId, listingKey], onDelete: Restrict)

  @@index([mlsId, listingKey])
  @@map("unit")
}

// Agents (Member)
model Member {
  memberKey     String  @id // RESO MemberKey
  mlsId         Int
  officeKey     String?
  firstName     String?
  lastName      String?
  email         String?
  phone         String?
  licenseNumber String?
  extrasJson    Json    @default("{}")

  // Relations
  mls Mls @relation(fields: [mlsId], references: [id], onDelete: Restrict)

  @@map("member")
}

// Offices
model Office {
  officeKey   String  @id
  mlsId       Int
  name        String?
  phone       String?
  addressFull String?
  city        String?
  state       String?
  postalCode  String?
  extrasJson  Json    @default("{}")

  // Relations
  mls Mls @relation(fields: [mlsId], references: [id], onDelete: Restrict)

  @@map("office")
}

// Lookup values (enums from provider metadata)
model LookupValue {
  id         BigInt @id @default(autoincrement())
  mlsId      Int
  lookupName String
  code       String
  display    String

  // Relations
  mls Mls @relation(fields: [mlsId], references: [id], onDelete: Restrict)

  @@unique([mlsId, lookupName, code])
  @@map("lookup_value")
}

// Price histories
model PriceHistory {
  id         BigInt   @id @default(autoincrement())
  mlsId      Int
  listingKey String
  changedAt  DateTime @db.Timestamptz(6)
  listPrice  Decimal? @db.Decimal(14, 2)

  // Relations
  mls     Mls     @relation(fields: [mlsId], references: [id], onDelete: Restrict)
  listing Listing @relation(fields: [mlsId, listingKey], references: [mlsId, listingKey], onDelete: Restrict)

  @@index([mlsId, listingKey])
  @@map("price_history")
}

// Status histories
model StatusHistory {
  id             BigInt   @id @default(autoincrement())
  mlsId          Int
  listingKey     String
  changedAt      DateTime @db.Timestamptz(6)
  standardStatus String?

  // Relations
  mls     Mls     @relation(fields: [mlsId], references: [id], onDelete: Restrict)
  listing Listing @relation(fields: [mlsId, listingKey], references: [mlsId, listingKey], onDelete: Restrict)

  @@index([mlsId, listingKey])
  @@map("status_history")
}
